<!DOCTYPE html>
<html lang="es">
<head>

	<meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Detenidos - Formato Completo Offline</title>

  <!-- Librer√≠as necesarias -->
  <script src="./jszip.min.js"></script>
  <script src="./FileSaver.min.js"></script>
  <script src="xlsx.full.min.js"></script>

  <!-- Plantillas Base64: deben definir window.PLANTILLAS con claves:
       { amarillas, azules, fax, derechos_ingles, derechos_espanol } -->
  <script src="./plantilla_amarillas.js"></script>
  <script src="./plantilla_azules.js"></script>
  <script src="./plantilla_fax.js"></script>
  <script src="./plantilla_derechos_ingles.js"></script>
  <script src="./plantilla_derechos_espanol.js"></script>
  <script src="./plantilla_derechos_arabe.js"></script>
  <script src="./plantilla_derechos_italiano.js"></script>
  <script src="./plantilla_derechos_ruso.js"></script>
  <style>
    :root { --primary:#3498db; --hover:#2980b9; --panel:rgba(0,0,0,0.75); --text:#fff; --field-bg:rgba(255,255,255,0.9); --border:#aaa; --radius:12px; --space:16px; --card-pad:14px; }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:url('fondo.jpg') no-repeat center center fixed;background-size:cover;min-height:100vh;display:flex;flex-direction:column;justify-content:center;}
    h1{text-align:center;margin:16px 0 20px;font-size:32px;font-weight:800;color:#fff;text-transform:uppercase;text-shadow:2px 2px 8px rgba(0,0,0,.7);}
    form{background:var(--panel);color:var(--text);border-radius:var(--radius);max-width:1400px;margin:0 auto 32px;padding:28px 32px;box-shadow:0 10px 28px rgba(0,0,0,.6);}
    h2{font-size:20px;text-transform:uppercase;margin-top:28px;margin-bottom:12px;border-bottom:2px solid var(--primary);padding-bottom:6px;letter-spacing:.5px;}
    .grid-rows{display:grid;grid-gap:var(--space);grid-template-columns: repeat(3, minmax(280px,1fr));}
    @media(max-width:1200px){.grid-rows{grid-template-columns:repeat(2,minmax(280px,1fr));}}
    @media(max-width:700px){.grid-rows{grid-template-columns:1fr;}}
    .field-card{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);border-radius:10px;padding:var(--card-pad);display:flex;flex-direction:column;gap:8px;min-height:94px;}
    label{font-weight:700;font-size:12px;margin-bottom:2px;text-transform:uppercase;letter-spacing:.6px;}
    input,select,textarea{width:100%;padding:5px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--field-bg);color:#000;}
    textarea{resize:vertical;min-height:56px;}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(52,152,219,.25);}
    .actions{text-align:center;margin-top:26px;}
    button{background:var(--primary);color:#fff;padding:14px 26px;border:none;border-radius:10px;font-weight:800;font-size:15px;text-transform:uppercase;cursor:pointer;letter-spacing:.6px;}
    button:hover{background:var(--hover);}
    #message{margin-top:12px;text-align:center;font-weight:bold;color:#fff;}
.full-width {
      grid-column: span 3;
    }
/* Reduce la altura por defecto de todas las tarjetas */
.field-card {
  padding: 10px;        /* antes var(--card-pad)=14px */
  gap: 6px;             /* antes 8px */
  min-height: 64px;     /* antes 94px */
}
textarea {
  min-height: 34px;     /* altura visible del textarea */
}

/* Ajuste responsivo para que en m√≥vil los campos de "Hechos" vayan en columna */
.grid-rows {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
}

.grid-rows .field-card {
  flex: 1;
  min-width: 200px; /* as√≠ en pantallas grandes a√∫n se ve en fila */
}

@media (max-width: 768px) {
  .grid-rows {
    flex-direction: column;   /* <--- fuerza apilado vertical */
  }
  .grid-rows .field-card {
    width: 100% !important;
    min-width: unset !important;
  }
}

input[type="time"] {
  width: 100px;   /* lo justo para HH:MM con espacio delante y detr√°s */
  text-align: center; /* centra el valor dentro del campo */
}

	  .field-card input[type="time"] {
  width: 100px !important;   /* fuerza anchura justa */
  text-align: center;        /* centra HH:MM */
  display: inline-block;     /* evita que se estire */
}

.field-card.small-width {
  max-width: 160px !important; /* fuerza el ancho del globo */
  flex: 0 0 160px !important;  /* no dejar que el flex de .grid-rows lo estire */
}
.field-card.small-width input[type="time"] {
  width: 100%; 
  text-align: center;
}
	  
  </style>

</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm" autocomplete="off">
    <h2>Datos de Filiaci√≥n</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: lightblue;">
        <label>Tipo Documento</label>
        <select name="TIPO DOCUMENTO_OPCION" id="tipoDocumento">
          <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
          <option value="DNI">DNI</option>
          <option value="NIE">NIE</option>
          <option value="PASAPORTE">PASAPORTE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TIPO DOCUMENTO" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>N¬∫ Documento</label>
        <input type="text" name="N¬∫DOCUMENTO" id="numeroDocumento">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Sexo</label>
        <select name="SEXO_OPCION" id="sexoOpcion">
          <option value="MASCULINO" selected>MASCULINO</option>
          <option value="FEMENINO">FEMENINO</option>
        </select>
      </div>
      <div class="field-card" style="color: lightblue;"><label>Nacionalidad</label><input type="text" name="NACIONALIDAD" id="nacionalidadtexto" placeholder="Pa√≠s"></div>
      <div class="field-card" style="color: lightblue;"><label>Nombre</label><input type="text" name="Nombre" id="Nombre"></div>
      <div class="field-card" style="color: lightblue;"><label>Apellidos</label><input type="text" name="APELLIDOS" id="APELLIDOS"></div>
     <div class="field-card" style="color: lightblue;">
  <label>Nombre de los Padres</label>
  <select name="NOMBRE_PADRES_OPCION" id="nombrePadresOpcion">
    <option value="NO APORTA" selected>NO APORTA</option>
    <option value="OTRO">OTRO</option>
  </select>
  <input type="text" name="NOMBRE_PADRES" id="nombrePadresTexto" placeholder="Especificar" style="display:none;">
</div>
      <div class="field-card" style="color: lightblue;"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
      <div class="field-card" style="color: lightblue;"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
      <div class="field-card" style="color: lightblue;">
        <label>Domicilio</label>
        <select name="DOMICILIO_OPCION" id="domicilioOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="DOMICILIO" maxlength="45" id="domicilioTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Tel√©fono</label>
        <select name="TEL√âFONO_OPCION" id="telefonoOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="tel" name="TEL√âFONO" id="telefonoTexto" placeholder="Especificar" style="display:none;"></div>
      <div class="field-card" style="color: red;"><label>Fecha actual por defecto</label><input type="text" name="FECHA_GENERACION" id="fechaGeneracion"></div>
    </div>


    <h2>Hechos</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: green;">
  <label>Delito(s)</label>
  <select id="delitoSelect">
    <option value="">-- Seleccionar --</option>
    <option value="HURTO">HURTO</option>
    <option value="DA√ëOS">DA√ëOS</option>
    <option value="ESTAFA">ESTAFA</option>
    <option value="ROBO CON FUERZA">ROBO CON FUERZA</option>
    <option value="ROBO USO DE VEHICULO">ROBO USO DE VEH√çCULO</option>
    <option value="HURTO USO DE VEHICULO">HURTO USO DE VEH√çCULO</option>
    <option value="ROBO CON VIOLENCIA">ROBO CON VIOLENCIA</option>
    <option value="LESIONES">LESIONES</option>
    <option value="AMENAZAS GRAVES">AMENAZAS GRAVES</option>
    <option value="MALOS TRATOS EN EL √ÅMBITO FAMILIAR">MALOS TRATOS EN EL √ÅMBITO FAMILIAR</option>
    <option value="ABUSO SEXUAL">ABUSO SEXUAL</option>
    <option value="ATENTADO AGENTE AUTORIDAD">ATENTADO AGENTE AUTORIDAD</option>
    <option value="DESOBEDIENCIA">DESOBEDIENCIA</option>
    <option value="CONTRA LA SEGURIDAD VIAL">CONTRA LA SEGURIDAD VIAL</option>
    <option value="CONTRA LA SALUD P√öBLICA">CONTRA LA SALUD P√öBLICA</option>
    <option value="TR√ÅFICO DE DROGAS">TR√ÅFICO DE DROGAS</option>
    <option value="FALSEDAD DOCUMENTAL">FALSEDAD DOCUMENTAL</option>
    <option value="RECLAMACI√ìN JUDICIAL">RECLAMACI√ìN JUDICIAL</option>
    <option value="QUEBRANTAMIENTO DE CONDENA">QUEBRANTAMIENTO DE CONDENA</option>
    <option value="OTRO">OTRO</option>
  </select>

  <!-- input para OTRO -->
  <input type="text" id="delitoOtroTexto" placeholder="Especificar" style="display:none;">

  <!-- sub-globo inferior -->
  <div id="delitosSeleccionados" style="margin-top:8px; padding:5px; border:1px solid #ccc; min-height:30px;">
    <em>Ning√∫n delito seleccionado</em>
  </div>
</div>
      <div class="field-card" style="color: lightgreen;"><label>Indicativo</label><input type="text" name="Indicativo" id="indicativotexto" placeholder="A-000"></div>
      <div class="field-card" style="color: lightgreen;"><label>C.P. Agentes</label><input type="text" name="C.P. AGENTES" id="agentestexto"></div>
      <div class="field-card" style="color: lightgreen;"><label>Diligencias</label><input type="text" name="DILIGENCIAS" id="diligenciatexto" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card" style="color: lightgreen;"><label>Instructor</label><input type="number" name="INSTRUCTOR" id="instructortexto" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar del hecho</label><input type="text" name="LUGAR DEL HECHO"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar de la detenci√≥n</label><input type="text" name="LUGAR DE LA DETENCI√ìN"></div>
      <div class="field-card" style="color: lightgreen;"><label>Hora del hecho</label><input type="time" name="HORA DEL HECHO" id="horaHecho"></div>
      <div class="field-card" style="color: lightgreen;"><label>Hora de la detenci√≥n</label><input type="time" name="HORA DE LA DETENCI√ìN" id="horaDetencion"></div>
      <div class="field-card full-width" style="color: lightgreen;">
  <label>Breve resumen de los hechos</label><textarea name="BREVE RESUMEN DE LOS HECHOS" id="brevetexto" placeholder="Ej: Autor de agresi√≥n con arma blanca..."></textarea>
</div>

<div class="field-card full-width" style="color: lightgreen;">
  <label>Indicios por los que se detiene</label><textarea name="INDICIOS POR LOS QUE SE DETIENE" id="indiciostexto" placeholder="Ej: Manifestaciones perjudicado, testigos..."></textarea>
</div>
	</div>
    <h2>Derechos</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: orange;">
        <label>Abogado</label>
        <select name="ABOGADO_OPCION" id="abogadoOpcion">
          <option value="DE OFICIO" selected>DE OFICIO</option>
          <option value="OTRO">PARTICULAR</option>
        </select>
        <input type="text" name="ABOGADO" id="abogadoTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>
      <div class="field-card" style="color: orange;">
        <label>Comunicarse con</label>
        <select name="COMUNICARSE CON_OPCION" id="comunicarseOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="COMUNICARSE CON:" id="comunicarseTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>
      <div class="field-card" style="color: orange;">
        <label>Informar de su detenci√≥n a:</label>
        <select name="INFORMAR DE SU DETENCI√ìN_OPCION" id="informardeOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="INFORMAR DE SU DETENCION A:" id="informardeTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>

      <div class="field-card" style="color: orange;">
  <label>Int√©rprete</label>
  <select name="INTERPRETE_OPCION" id="interpreteOpcion">
    <option value="NO" selected>NO</option>
    <option value="INGL√âS">INGL√âS</option>
    <option value="√ÅRABE">√ÅRABE</option>
    <option value="ITALIANO">ITALIANO</option>
    <option value="RUSO">RUSO</option>
    <option value="OTRO">OTRO</option>
  </select>
  <input type="text" name="IDIOMA" id="idioma" placeholder="Especificar idioma/contexto" style="display:none;">
</div>
      <div class="field-card" style="color: orange;">
        <label>M√©dico</label>
        <select name="MEDICO" id="medico">
          <option value="NO" selected>NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
      <div class="field-card" style="color: orange;">
        <label>Consulado</label>
        <select name="CONSULADO" id="consulado">
          <option value="NO" selected>NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
    </div>

<div class="actions">
  <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none">

  <!-- Bot√≥n DESCARGA ZIP (teal con icono) -->
  <button type="button" onclick="generarZipUnicoSeguro()" 
          style="background: teal; color: white; padding: .5rem 1rem; font-size: 16px; 
                 cursor: pointer; display: block; width: 100%; margin-bottom: 20px; 
                 border: none; border-radius: 5px;">
    üóÇ Descarga de ZIP
  </button>

  <!-- Bot√≥n CARGAR XLSX (verde con icono de carpeta) -->
  <button type="button" onclick="cargarExcel()" 
          style="background: #28a745; color: white; padding: .5rem 1rem; font-size: 16px; 
                 cursor: pointer; display: block; width: 100%; margin-bottom: 20px; 
                 border: none; border-radius: 5px;">
    üìÇ Cargar XLSX
  </button>

  <!-- Bot√≥n REFRESCAR (azul con icono de recarga) -->
  <button type="button" onclick="location.reload();" 
          style="background: #007bff; color: white; padding: .5rem 1rem; font-size: 16px; 
                 cursor: pointer; display: block; width: 100%; 
                 border: none; border-radius: 5px;">
    üîÑ Refrescar
  </button>
</div>

<div id="message"></div>
</form>

  <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none;">

  <script>
    // Helpers
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
    function buildFlexibleRegex(key){
      const chars = key.split("").map(c=>escapeRegExp(c));
      const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
      return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*"+flexible+"(?:\\s|<[^>]+>|&nbsp;)*\\}\\}","gi");
    }
    function toAsciiFileName(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/√±/gi,'n').replace(/[^A-Za-z0-9._-]+/g,'_');}
    function xmlEscape(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function sanitizeForFilename(s){return String(s||'').replace(/[\/\\:*?"<>|]+/g,' ').trim();}
    function U(s){ return String(s ?? '').toUpperCase(); } // MAY√öSCULAS

    // Mostrar inputs "OTRO" + bloquear N¬∫DOC si indocumentado + mostrar IDIOMA si int√©rprete "OTRO"
    document.addEventListener('change',e=>{
      if(e.target.id==="tipoDocumento"){
        const val=e.target.value;
        document.getElementById('tipoDocumentoOtro').style.display=(val==="OTRO")?"block":"none";
        const num=document.getElementById("numeroDocumento");
        if(val==="INDOCUMENTADO/A"){ num.value=""; num.disabled=true; } else { num.disabled=false; }
      }
      if(e.target.id==="interpreteOpcion"){
        document.getElementById('idioma').style.display=(e.target.value==="OTRO")?"block":"none";
      }
      // Mostrar/ocultar campos de texto asociados a "OTRO"
      if(e.target.tagName==="SELECT" && e.target.closest('.field-card')){
        const input=e.target.closest('.field-card').querySelector('input[type="text"]');
        if(input && !["tipoDocumento","interpreteOpcion"].includes(e.target.id)){
          input.style.display=(e.target.value==="OTRO")?"block":"none";
        }
      }
    });

const selectDelito = document.getElementById("delitoSelect");
const lista = document.getElementById("delitosSeleccionados");
const inputOtro = document.getElementById("delitoOtroTexto");
let delitosElegidos = [];

selectDelito.addEventListener("change", ()=>{
  const val = selectDelito.value;
  
  if (val === "OTRO") {
    inputOtro.style.display = "inline-block";
    inputOtro.focus();
    return;
  }
  
  if (val && !delitosElegidos.includes(val)) {
    delitosElegidos.push(val);
    renderDelitos();
  }
  // reset
  selectDelito.value = "";
});

inputOtro.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const val = inputOtro.value.trim();
    if(val && !delitosElegidos.includes(val)){
      delitosElegidos.push(val);
      renderDelitos();
    }
    inputOtro.value="";
    inputOtro.style.display="none";
    selectDelito.value="";
  }
});

function renderDelitos() {
  lista.innerHTML="";
  if(delitosElegidos.length===0){
    lista.innerHTML="<em>Ning√∫n delito seleccionado</em>";
    return;
  }
  delitosElegidos.forEach((d,i)=>{
    const span=document.createElement("span");
    span.textContent=d;
    span.style.cssText="padding:3px 6px; margin:2px; background:#eef; border:1px solid #99c; border-radius:4px; display:inline-block; cursor:pointer;";
    span.title="Click para eliminar";
    span.addEventListener("click", ()=>{ 
      delitosElegidos.splice(i,1);
      renderDelitos();
    });
    lista.appendChild(span);
  });
}

// Normaliza: quita acentos, pasa a may√∫sculas y compacta
function normalizeKey(str) {
  return str
    ? str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/[^A-Z0-9]/g,"").trim()
    : "";
}

// Auxiliar: maneja selects con input asociado (NO APORTA / OTRO)
function setSelectWithInput(selectName, excelValue) {
  const select = document.querySelector(`[name="${selectName}"]`);
  if (!select) return;

  const card = select.closest(".field-card");
  const textInput = card ? card.querySelector("input[type=text], textarea") : null;
  const normExcel = normalizeKey(excelValue);

  let matched = false;
  for (const opt of select.options) {
    if (normalizeKey(opt.value) === normExcel) {
      select.value = opt.value;
      matched = true;
      if (textInput) textInput.value = "";
      break;
    }
  }

  if (!matched) {
    if (!excelValue || ["NOAPORTA","NO","DEOFICIO"].includes(normExcel)) {
      // Selecciona opci√≥n directa
      const fallback = Array.from(select.options).find(opt =>
        ["NOAPORTA","NO","DEOFICIO"].includes(normalizeKey(opt.value))
      );
      if (fallback) select.value = fallback.value;
      if (textInput) textInput.value = "";
    } else {
      // Valor libre ‚Üí OTRO
      const otherOpt = Array.from(select.options).find(opt => normalizeKey(opt.value) === "OTRO");
      if (otherOpt) select.value = otherOpt.value;
      if (textInput) textInput.value = excelValue;
    }
  }

  select.dispatchEvent(new Event("change"));
}

    // Cargar Excel previo
    async function cargarExcel() {
  const input = document.getElementById("fileInputXLSX");
  input.click();

  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      rows.forEach(([pregunta, respuesta]) => {
        if (!pregunta) return;
        const qNorm = normalizeKey(pregunta);
        const r = (respuesta || "").toString().trim();

        // ---- Casos con combo "NO APORTA/OTRO" ----
        if (qNorm === "DOMICILIO") { setSelectWithInput("DOMICILIO_OPCION", r); return; }
        if (qNorm === "TELEFONO") { setSelectWithInput("TEL√âFONO_OPCION", r); return; }
        if (qNorm === "NOMBREDELOSPADRES") { setSelectWithInput("NOMBRE_PADRES_OPCION", r); return; }
        if (qNorm === "ABOGADO") { setSelectWithInput("ABOGADO_OPCION", r); return; }
        if (qNorm === "COMUNICARSECON") { setSelectWithInput("COMUNICARSE CON_OPCION", r); return; }
        if (qNorm === "INFORMARDESUDETENCION" || qNorm === "INFORMARDESUDETENCIONA") {
          setSelectWithInput("INFORMAR DE SU DETENCI√ìN_OPCION", r); return;
        }
        if (qNorm === "INTERPRETE") { setSelectWithInput("INTERPRETE_OPCION", r); return; }

        // ---- Caso especial: delitos m√∫ltiples ----
        if (qNorm === "DELITO") {
          delitosElegidos = r.split(/,\s*|\s+y\s+/).map(v => v.trim()).filter(Boolean);
          renderDelitos();
          return;
        }

        // ---- Campos simples (input/select/textarea) ----
        const allInputs = document.querySelectorAll("[name]");
        for (const el of allInputs) {
          const elNorm = normalizeKey(el.name);
          if (elNorm === qNorm) {
            if (el.tagName === "SELECT") {
              el.value = r;
              el.dispatchEvent(new Event("change"));
            } else {
              el.value = r;
            }
            break;
          }
        }
      });

      document.getElementById("message").innerText = "‚úÖ XLSX cargado y formulario rellenado";
    } catch (err) {
      console.error(err);
      document.getElementById("message").innerText = "‚ùå Error al cargar XLSX: " + (err?.message || err);
    }
  };
}

    // Guardar con File System Access (evita MOTW)
    async function saveBlob(blob, filename){
      if(window.showSaveFilePicker){
        try{
          const handle=await window.showSaveFilePicker({
            suggestedName:filename,
            types:[{description:'Archivo ZIP',accept:{'application/zip':['.zip']}}]
          });
          const writable=await handle.createWritable();
          await writable.write(blob); await writable.close(); return;
        }catch(e){console.warn('FSA fallback',e);}
      }
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);
      a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1500);
    }

    // Generar ODT con reemplazos en MAY√öSCULAS
    async function generarODTUint8(base64,dataUpper){
      const bytes=Uint8Array.from(atob(base64.replace(/[\r\n\t ]+/g,"")),c=>c.charCodeAt(0));
      const zip=await JSZip.loadAsync(bytes);
      let xml=await zip.file("content.xml").async("string");

      for(const k in dataUpper){
        const v=(dataUpper[k]??"").toString();
        xml = xml.replace(buildFlexibleRegex(k), v);
        xml = xml.replace(new RegExp("\\{\\{\\s*"+escapeRegExp(k)+"\\s*\\}\\}","g"), v);
      }
      // Limpia cualquier resto {{...}}
      xml = xml.replace(/{{\s*[^}]+\s*}}/g,"");

      zip.file("content.xml",xml);
      return await zip.generateAsync({type:"uint8array",compression:"DEFLATE"});
    }

    // Generar XLSX sin cabecera, dos columnas, ancho m√°x 40 chars, A derecha, B centrada, horas con formato h:mm
    async function generarXLSXUint8(rows, sheetName="Resumen"){
      const x = new JSZip();

      const contentTypes =
`<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;

      const rels =
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;

      const wb =
`<?xml version="1.0" encoding="UTF-8"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <bookViews><workbookView/></bookViews>
  <sheets>
    <sheet name="${xmlEscape(sheetName)}" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>`;

      const wbRels =
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

      // Estilos: 0 base, 1 preguntas (derecha), 2 respuestas (centro), 3 hora (centro + num)
      const styles =
`<?xml version="1.0" encoding="UTF-8"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <numFmts count="1">
    <numFmt numFmtId="165" formatCode="h:mm"/>
  </numFmts>
  <fonts count="1">
    <font><sz val="11"/><color theme="1"/><name val="Calibri"/></font>
  </fonts>
  <fills count="1"><fill><patternFill patternType="none"/></fill></fills>
  <borders count="1"><border><left/><right/><top/><bottom/><diagonal/></border></borders>
  <cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
  <cellXfs count="4">
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="top"/></xf>
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="top" horizontal="right"/></xf>
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="center" horizontal="center"/></xf>
    <xf numFmtId="165" fontId="0" fillId="0" borderId="0" applyNumberFormat="1" applyAlignment="1"><alignment vertical="center" horizontal="center"/></xf>
  </cellXfs>
  <cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles>
</styleSheet>`;

      // Ancho m√°x 40 caracteres en ambas columnas
      const cols = `<cols>
        <col min="1" max="1" width="40" customWidth="1"/>
        <col min="2" max="2" width="40" customWidth="1"/>
      </cols>`;

      // Utilidad para convertir "HH:MM" a fracci√≥n de d√≠a Excel
      function parseTimeToExcelFraction(str){
        const m = /^(\d{1,2}):(\d{2})$/.exec(str||"");
        if(!m) return null;
        const h = Math.min(23, parseInt(m[1],10));
        const mm = Math.min(59, parseInt(m[2],10));
        return (h/24) + (mm/1440);
      }

      function cellInline(r, cIdx, text, style){
        const col = (cIdx===1?'A':'B');
        const ref = col + r;
        const s = (style!=null)?` s="${style}"`:'';
        return `<c r="${ref}" t="inlineStr"${s}><is><t>${xmlEscape(text||'')}</t></is></c>`;
      }
      function cellNumber(r, cIdx, num, style){
        const col = (cIdx===1?'A':'B');
        const ref = col + r;
        the_s = (style!=null)?` s="${style}"`:'';
        return `<c r="${ref}"${the_s}><v>${num}</v></c>`;
      }

      let rowXml = '';
      for(let i=0;i<rows.length;i++){
        const r = i+1;
        const pregunta = rows[i][0] ?? '';
        const respuesta = rows[i][1] ?? '';

        // Columna A: preguntas, DERECHA (style 1)
        const a = cellInline(r,1,pregunta,1);

        // Columna B: respuestas, CENTRO (style 2) o HORA (style 3)
        let b;
        if(pregunta==="Hora del hecho" || pregunta==="Hora de la detenci√≥n"){
          const frac = parseTimeToExcelFraction(respuesta);
          if(frac!=null){ b = cellNumber(r,2,frac,3); } else { b = cellInline(r,2,respuesta,2); }
        } else {
          b = cellInline(r,2,respuesta,2);
        }

        rowXml += `<row r="${r}" spans="1:2">${a}${b}</row>`;
      }

      const sheet =
`<?xml version="1.0" encoding="UTF-8"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  ${cols}
  <sheetData>
    ${rowXml}
  </sheetData>
  <sheetViews>
    <sheetView tabSelected="1" workbookViewId="0"/>
  </sheetViews>
</worksheet>`;

      const core =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"
 xmlns:dc="http://purl.org/dc/elements/1.1/"
 xmlns:dcterms="http://purl.org/dc/terms/"
 xmlns:dcmitype="http://purl.org/dcmitype/"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:title>Resumen Registro</dc:title>
  <dc:subject>Registro de Detenidos</dc:subject>
  <dc:creator>Formulario Registro</dc:creator>
  <cp:lastModifiedBy>Formulario Registro</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
  <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
</cp:coreProperties>`;

      const app =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"
 xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>Formulario Registro</Application>
  <DocSecurity>0</DocSecurity>
  <ScaleCrop>false</ScaleCrop>
  <Company></Company>
  <LinksUpToDate>false</LinksUpToDate>
  <SharedDoc>false</SharedDoc>
  <HyperlinksChanged>false</HyperlinksChanged>
  <AppVersion>16.0000</AppVersion>
</Properties>`;

      x.file('[Content_Types].xml', contentTypes);
      x.folder('_rels').file('.rels', rels);
      const xl = x.folder('xl');
      xl.file('workbook.xml', wb);
      xl.folder('_rels').file('workbook.xml.rels', wbRels);
      xl.file('styles.xml', styles);
      xl.folder('worksheets').file('sheet1.xml', sheet);
      const props = x.folder('docProps');
      props.file('core.xml', core);
      props.file('app.xml', app);

      return await x.generateAsync({type:'uint8array'});
    }

    async function generarZipUnicoSeguro(){
      const msg=document.getElementById("message"); msg.innerText="Generando ZIP...";
      try{
        const form=document.getElementById("registroForm");
        const fd=new FormData(form); const data={}; fd.forEach((v,k)=>data[k]=v);


        // Normalizaciones previas
        const optTD=data["TIPO DOCUMENTO_OPCION"];
        data["TIPO DOCUMENTO"] = (optTD==="OTRO") ? (data["TIPO DOCUMENTO"]||"") : optTD;
        if(optTD==="INDOCUMENTADO/A"){ data["N¬∫DOCUMENTO"] = ""; } else { data["N¬∫DOCUMENTO"] = data["N¬∫DOCUMENTO"] || ""; }
        data["SEXO"]=data["SEXO_OPCION"] || "";
        data["INSTRUCTOR"] = data["INSTRUCTOR"] || "";
	data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || '';

	// üìå Normalizar delitos elegidos en sub-globo
let delitoTexto="";
if (delitosElegidos.length===1){
  delitoTexto=delitosElegidos[0];
} else if (delitosElegidos.length===2){
  delitoTexto=delitosElegidos[0]+" y "+delitosElegidos[1];
} else if (delitosElegidos.length>2){
  delitoTexto=delitosElegidos.slice(0,-1).join(", ")+" y "+delitosElegidos[delitosElegidos.length-1];
}
data["DELITO"]=delitoTexto;

        const abOpt = data["ABOGADO_OPCION"];
        if(abOpt==="DE OFICIO"){ data["ABOGADO"]="de oficio."; }
        else if(abOpt==="OTRO"){ data["ABOGADO"]= (data["ABOGADO"]||""); }
        else { data["ABOGADO"]= data["ABOGADO"] || ""; }

        const ccOpt = data["COMUNICARSE CON_OPCION"];
        if(ccOpt==="NADIE"){ data["COMUNICARSE CON:"]="nadie."; }
        else if(ccOpt==="OTRO"){ data["COMUNICARSE CON:"]= (data["COMUNICARSE CON:"]||""); }
        else { data["COMUNICARSE CON:"]= data["COMUNICARSE CON:"] || ""; }

	const infOpt = data["INFORMAR DE SU DETENCION A:_OPCION"];
        if(infOpt==="NADIE"){ data["INFORMAR DE SU DETENCION A:"]="nadie."; }
        else if(infOpt==="OTRO"){ data["INFORMAR DE SU DETENCION A:"]= (data["INFORMAR DE SU DETENCION A:"]||""); }
        else { data["INFORMAR DE SU DETENCION A:"]= data["INFORMAR DE SU DETENCION A:"] || ""; }


        const intOpt = data["INTERPRETE_OPCION"] || "NO";
let interpreteDisplay = "NO";

if (intOpt === "OTRO") {
  interpreteDisplay = data["IDIOMA"] || "";
} else if (intOpt !== "NO") {
  // Si es INGL√âS, √ÅRABE, ITALIANO, RUSO...
  interpreteDisplay = intOpt;

// üîë Alias para ODT: soportar {{IDIOMA}} o {{INTERPRETE}}
data["IDIOMA"] = interpreteDisplay;
data["INTERPRETE"] = interpreteDisplay;

}

	const nomDisplay = (data["NOMBRE_PADRES_OPCION"]==="OTRO") ? (data["NOMBRE_PADRES"]||"") : (data["NOMBRE_PADRES_OPCION"]||"");
        const domDisplay = (data["DOMICILIO_OPCION"]==="OTRO") ? (data["DOMICILIO"]||"") : (data["DOMICILIO_OPCION"]||"");
        const telDisplay = (data["TEL√âFONO_OPCION"]==="OTRO") ? (data["TEL√âFONO"]||"") : (data["TEL√âFONO_OPCION"]||"");

        data["MEDICO"] = (data["MEDICO"]==="SI") ? "SI" : "NO";
        data["CONSULADO"] = (data["CONSULADO"]==="SI") ? "SI" : "NO";

        // Asegurar que en ODT tambi√©n salga "NO APORTA" si es la opci√≥n por defecto
	data["NOMBRE_PADRES"] = nomDisplay;
	data["Nombre de los Padres"] = nomDisplay;
        data["DOMICILIO"] = domDisplay;
        data["TEL√âFONO"] = telDisplay;

        // Construir mapa en MAY√öSCULAS para ODT
        const dataUpper = {};
        for(const k in data){
          dataUpper[k] = U(data[k]);
        }
const zip = new JSZip();
        // üîé Construir nombre base para carpeta y archivos
function removeDiacritics(s){
  return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/√±/gi,'n');
}

const diligPartRaw = String(data["DILIGENCIAS"] || '').replace(/\//g, '-').trim();
const delitoPart   = String(data["DELITO"] || '').trim();
const nombrePart   = String(data["Nombre"] || '').trim();
const apellidosPart= String(data["APELLIDOS"] || '').trim();

let combined = `${diligPartRaw} ${delitoPart} ${nombrePart} ${apellidosPart}`.trim()
  .replace(/_/g,' ')
  .replace(/\s+/g,' ');

combined = removeDiacritics(combined).replace(/[^A-Za-z0-9 \-]/g,'').trim();

const base = combined.toUpperCase() || "DOCUMENTO";

// üìÇ Crear carpeta interna del ZIP
const folder = zip.folder(base);

// üëÆ‚Äç‚ôÇÔ∏è Calcular edad
function calcularEdad(fechaStr){
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(fechaStr||"");
  if(!m) return null;
  const dia=parseInt(m[1],10), mes=parseInt(m[2],10)-1, anio=parseInt(m[3],10);
  const nacimiento=new Date(anio, mes, dia), hoy=new Date();
  let edad=hoy.getFullYear()-nacimiento.getFullYear();
  const mDiff=hoy.getMonth()-nacimiento.getMonth();
  if(mDiff<0 || (mDiff===0 && hoy.getDate()<nacimiento.getDate())) edad--;
  return edad;
}
const edad = calcularEdad(data["FECHA DE NACIMIENTO"]);

// üìÑ Construir lista de documentos
let docs = [
  { key:"fax", name:`Fax.odt` },
  { key:"derechos_espanol", name:`derechos_esp.odt` }
];

// Edad ‚Üí amarillas/azules
if (edad !== null) {
  if (edad >= 18) docs.unshift({ key:"amarillas", name:`amarillas.odt` });
  else docs.unshift({ key:"azules", name:`azules.odt` });
} else {
  docs.unshift({ key:"azules", name:`azules.odt` });
  docs.unshift({ key:"amarillas", name:`amarillas.odt` });
}

// Int√©rprete ‚Üí idioma adicional
const idiomaSel = (intOpt || "").trim().toUpperCase();
switch (idiomaSel) {
  case "INGL√âS":
    docs.push({ key:"derechos_ingles", name:`derechos_ing.odt` });
    break;
  case "√ÅRABE":
    docs.push({ key:"derechos_arabe", name:`derechos_arabe.odt` });
    break;
  case "ITALIANO":
    docs.push({ key:"derechos_italiano", name:`derechos_ita.odt` });
    break;
  case "RUSO":
    docs.push({ key:"derechos_ruso", name:`derechos_ruso.odt` });
    break;
  case "OTRO":
    const idiomaOtro = (data["IDIOMA"]||"").trim().toLowerCase();
    if (idiomaOtro) {
      const keyCustom = `derechos_${idiomaOtro}`;
      if (PLANTILLAS[keyCustom]) {
        docs.push({ key:keyCustom, name:`${keyCustom}_${base}.odt` });
      }
    }
    break;
}

// üìù Generar ODTs dentro de la carpeta
let ok=0;
for(const d of docs){
  if(!PLANTILLAS[d.key]) continue;
  const odt=await generarODTUint8(PLANTILLAS[d.key],dataUpper);
  folder.file(d.name, odt, {compression:"STORE"});
  ok++;
}

// üßæ Generar XLSX de resumen
const hoy = new Date();
const dd=String(hoy.getDate()).padStart(2,'0');
const mm=String(hoy.getMonth()+1).padStart(2,'0');
const yyyy=String(hoy.getFullYear());
const fechaStr=`${dd}-${mm}-${yyyy}`;
const excelName = `${sanitizeForFilename(data["Nombre"]||"")} ${sanitizeForFilename(data["APELLIDOS"]||"")} ${fechaStr}.xlsx`.trim();

const filas = [
  ["Nombre", U(data["Nombre"])],
  ["Apellidos", U(data["APELLIDOS"])],
  ["Tipo de documento", U(data["TIPO DOCUMENTO"])],
  ["N¬∫ Documento", U(data["N¬∫DOCUMENTO"])],
  ["Sexo", U(data["SEXO"])],
  ["Nacionalidad", U(data["NACIONALIDAD"])],
  ["Nombre de los Padres", U(data["Nombre de los Padres"])],
  ["Fecha de nacimiento", U(data["FECHA DE NACIMIENTO"])],
  ["Lugar de nacimiento", U(data["LUGAR DE NACIMIENTO"])],
  ["Domicilio", U(domDisplay)],
  ["Tel√©fono", U(telDisplay)],
  ["Delito", U(data["DELITO"])],
  ["C.P. Agentes", U(data["C.P. AGENTES"])],
  ["Diligencias", U(data["DILIGENCIAS"])],
  ["Instructor", U(data["INSTRUCTOR"])],
  ["Lugar del hecho", U(data["LUGAR DEL HECHO"])],
  ["Lugar de la detenci√≥n", U(data["LUGAR DE LA DETENCI√ìN"])],
  ["Hora del hecho", (document.getElementById('horaHecho')?.value || data["HORA DEL HECHO"] || "").trim()],
  ["Hora de la detenci√≥n", (document.getElementById('horaDetencion')?.value || data["HORA DE LA DETENCI√ìN"] || "").trim()],
  ["Breve resumen de los hechos", U(data["BREVE RESUMEN DE LOS HECHOS"])],
  ["Indicios por los que se detiene", U(data["INDICIOS POR LOS QUE SE DETIENE"])],
  ["Abogado", U(data["ABOGADO"])],
  ["Comunicarse con", U(data["COMUNICARSE CON:"])],
  ["Informar de su detenci√≥n a:", U(data["INFORMAR DE SU DETENCION A:"])],
  ["Int√©rprete", U(interpreteDisplay)],
  ["M√©dico", U(data["MEDICO"])],
  ["Consulado", U(data["CONSULADO"])],
  ["Indicativo", U(data["Indicativo"])],
  ["Fecha de generaci√≥n", U(data["FECHA_GENERACION"])]
];

const xlsx = await generarXLSXUint8(filas,"Resumen");
folder.file(excelName || `resumen_${base}.xlsx`, xlsx, {compression:"STORE"});

// üéÅ Guardar ZIP
const blob=await zip.generateAsync({type:"blob",compression:"STORE"});
await saveBlob(blob, `${base}.zip`);
msg.innerText=`‚úÖ ZIP generado (${ok} ODT + XLSX)`;
      }catch(err){
        console.error(err);
        msg.innerText="‚ùå "+(err?.message||err);
      }
    }
  </script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const hoy = new Date();
  const dia = String(hoy.getDate()).padStart(2, '0');
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const anio = hoy.getFullYear();
  const fecha = `${dia}/${mes}/${anio}`;

  const inputFecha = document.getElementById("fechaGeneracion");
  if (inputFecha && !inputFecha.value) {
    inputFecha.value = fecha;
  }
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registrado con √©xito:', registration);
        })
        .catch(error => {
          console.log('Fallo en el registro del Service Worker:', error);
        });
    });
  }
</script>

<style>
  body {
    font-family: sans-serif;
    padding: 10px;
    margin: 0;
  }
  .field-card {
    display: block;
    margin-bottom: 1rem;
  }
  .field-card label {
    display: block;
    font-weight: bold;
    margin-bottom: .25rem;
  }
  .field-card input, .field-card select, .field-card textarea {
    width: 100%;
    padding: .5rem;
    box-sizing: border-box;
    font-size: 16px; /* para que en iOS no haga zoom raro */
  }
  button {
    width: 100%;
    padding: 1rem;
    font-size: 18px;
  }
</style>

</body>
</html>




















