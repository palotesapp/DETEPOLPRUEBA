<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro de Detenidos - Versión Móvil</title>

  <!-- Librerías necesarias -->
  <script src="./jszip.min.js"></script>
  <script src="xlsx.full.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      margin: 0;
      background: #222;
      color: #eee;
    }
    .field-card {
      display: block;
      margin-bottom: 1rem;
    }
    .field-card label {
      display: block;
      font-weight: bold;
      margin-bottom: .25rem;
      color: lightblue;
    }
    .field-card input, .field-card select, .field-card textarea {
      width: 100%;
      padding: .5rem;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    .field-card textarea {
      min-height: 60px;
      resize: vertical;
    }
    input[type="time"] {
      width: 100px;
      text-align: center;
    }
    button {
      width: 100%;
      padding: 1rem;
      font-size: 18px;
      background: teal;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    button:hover {
      background: #006666;
    }
    #message {
      text-align: center;
      font-weight: bold;
      margin-top: 0.5rem;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm" autocomplete="off">
    <div class="field-card">
      <label for="tipoDocumento">Tipo Documento</label>
      <select name="TIPO DOCUMENTO_OPCION" id="tipoDocumento">
        <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
        <option value="DNI">DNI</option>
        <option value="NIE">NIE</option>
        <option value="PASAPORTE">PASAPORTE</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="TIPO DOCUMENTO" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
    </div>

    <div class="field-card">
      <label for="numeroDocumento">Nº Documento</label>
      <input type="text" name="NºDOCUMENTO" id="numeroDocumento">
    </div>

    <div class="field-card">
      <label for="sexoOpcion">Sexo</label>
      <select name="SEXO_OPCION" id="sexoOpcion">
        <option value="MASCULINO" selected>MASCULINO</option>
        <option value="FEMENINO">FEMENINO</option>
      </select>
    </div>

    <div class="field-card">
      <label for="nacionalidadtexto">Nacionalidad</label>
      <input type="text" name="NACIONALIDAD" id="nacionalidadtexto" placeholder="País">
    </div>

    <div class="field-card">
      <label for="Nombre">Nombre</label>
      <input type="text" name="Nombre" id="Nombre">
    </div>

    <div class="field-card">
      <label for="APELLIDOS">Apellidos</label>
      <input type="text" name="APELLIDOS" id="APELLIDOS">
    </div>

    <div class="field-card">
      <label for="nombrePadresOpcion">Nombre de los Padres</label>
      <select name="NOMBRE_PADRES_OPCION" id="nombrePadresOpcion">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="NOMBRE_PADRES" id="nombrePadresTexto" placeholder="Especificar" style="display:none;">
    </div>

    <div class="field-card">
      <label for="fechaNacimiento">Fecha de nacimiento</label>
      <input type="text" name="FECHA DE NACIMIENTO" id="fechaNacimiento" placeholder="DD/MM/AAAA">
    </div>

    <div class="field-card">
      <label for="lugarNacimiento">Lugar de nacimiento</label>
      <input type="text" name="LUGAR DE NACIMIENTO" id="lugarNacimiento">
    </div>

    <div class="field-card">
      <label for="domicilioOpcion">Domicilio</label>
      <select name="DOMICILIO_OPCION" id="domicilioOpcion">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="DOMICILIO" maxlength="45" id="domicilioTexto" placeholder="Especificar" style="display:none;">
    </div>

    <div class="field-card">
      <label for="telefonoOpcion">Teléfono</label>
      <select name="TELÉFONO_OPCION" id="telefonoOpcion">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="tel" name="TELÉFONO" id="telefonoTexto" placeholder="Especificar" style="display:none;">
    </div>

    <div class="field-card" style="color: red;">
      <label for="fechaGeneracion">Fecha actual por defecto</label>
      <input type="text" name="FECHA_GENERACION" id="fechaGeneracion" readonly>
    </div>

    <div class="field-card" style="color: green;">
      <label for="delitoSelect">Delito(s)</label>
      <select id="delitoSelect">
        <option value="">-- Seleccionar --</option>
        <option value="HURTO">HURTO</option>
        <option value="DAÑOS">DAÑOS</option>
        <option value="ESTAFA">ESTAFA</option>
        <option value="ROBO CON FUERZA">ROBO CON FUERZA</option>
        <option value="ROBO USO DE VEHICULO">ROBO USO DE VEHÍCULO</option>
        <option value="HURTO USO DE VEHICULO">HURTO USO DE VEHÍCULO</option>
        <option value="ROBO CON VIOLENCIA">ROBO CON VIOLENCIA</option>
        <option value="LESIONES">LESIONES</option>
        <option value="AMENAZAS GRAVES">AMENAZAS GRAVES</option>
        <option value="MALOS TRATOS EN EL ÁMBITO FAMILIAR">MALOS TRATOS EN EL ÁMBITO FAMILIAR</option>
        <option value="ABUSO SEXUAL">ABUSO SEXUAL</option>
        <option value="ATENTADO AGENTE AUTORIDAD">ATENTADO AGENTE AUTORIDAD</option>
        <option value="DESOBEDIENCIA">DESOBEDIENCIA</option>
        <option value="CONTRA LA SEGURIDAD VIAL">CONTRA LA SEGURIDAD VIAL</option>
        <option value="CONTRA LA SALUD PÚBLICA">CONTRA LA SALUD PÚBLICA</option>
        <option value="TRÁFICO DE DROGAS">TRÁFICO DE DROGAS</option>
        <option value="FALSEDAD DOCUMENTAL">FALSEDAD DOCUMENTAL</option>
        <option value="RECLAMACIÓN JUDICIAL">RECLAMACIÓN JUDICIAL</option>
        <option value="QUEBRANTAMIENTO DE CONDENA">QUEBRANTAMIENTO DE CONDENA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" id="delitoOtroTexto" placeholder="Especificar" style="display:none;">
      <div id="delitosSeleccionados" style="margin-top:8px; padding:5px; border:1px solid #ccc; min-height:30px; color: #000;">
        <em>Ningún delito seleccionado</em>
      </div>
    </div>

    <div class="field-card">
      <label for="horaHecho">Hora del hecho</label>
      <input type="time" name="HORA DEL HECHO" id="horaHecho">
    </div>

    <div class="field-card">
      <label for="horaDetencion">Hora de la detención</label>
      <input type="time" name="HORA DE LA DETENCIÓN" id="horaDetencion">
    </div>

    <div class="field-card">
      <label for="brevetexto">Breve resumen de los hechos</label>
      <textarea name="BREVE RESUMEN DE LOS HECHOS" id="brevetexto" placeholder="Ej: Autor de agresión con arma blanca..."></textarea>
    </div>

    <div class="field-card">
      <label for="indiciostexto">Indicios por los que se detiene</label>
      <textarea name="INDICIOS POR LOS QUE SE DETIENE" id="indiciostexto" placeholder="Ej: Manifestaciones perjudicado, testigos..."></textarea>
    </div>

    <div class="field-card">
      <label for="abogadoOpcion">Abogado</label>
      <select name="ABOGADO_OPCION" id="abogadoOpcion">
        <option value="DE OFICIO" selected>DE OFICIO</option>
        <option value="OTRO">PARTICULAR</option>
      </select>
      <input type="text" name="ABOGADO" id="abogadoTexto" placeholder="Nombre y teléfono" style="display:none;">
    </div>

    <div class="field-card">
      <label for="comunicarseOpcion">Comunicarse con</label>
      <select name="COMUNICARSE CON_OPCION" id="comunicarseOpcion">
        <option value="NADIE" selected>NADIE</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="COMUNICARSE CON:" id="comunicarseTexto" placeholder="Nombre y teléfono" style="display:none;">
    </div>

    <div class="field-card">
      <label for="informardeOpcion">Informar de su detención a:</label>
      <select name="INFORMAR DE SU DETENCIÓN_OPCION" id="informardeOpcion">
        <option value="NADIE" selected>NADIE</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="INFORMAR DE SU DETENCION A:" id="informardeTexto" placeholder="Nombre y teléfono" style="display:none;">
    </div>

    <div class="field-card">
      <label for="interpreteOpcion">Intérprete</label>
      <select name="INTERPRETE_OPCION" id="interpreteOpcion">
        <option value="NO" selected>NO</option>
        <option value="INGLÉS">INGLÉS</option>
        <option value="ÁRABE">ÁRABE</option>
        <option value="ITALIANO">ITALIANO</option>
        <option value="RUSO">RUSO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="IDIOMA" id="idioma" placeholder="Especificar idioma/contexto" style="display:none;">
    </div>

    <div class="field-card">
      <label for="medico">Médico</label>
      <select name="MEDICO" id="medico">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </div>

    <div class="field-card">
      <label for="consulado">Consulado</label>
      <select name="CONSULADO" id="consulado">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </div>

  </form>

  <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none;">

  <button type="button" onclick="cargarExcel()">📂 Cargar XLSX</button>
  <button type="button" onclick="generarXLSXResumen()">🗂 Descargar XLSX Resumen</button>

  <div id="message"></div>

  <script src="./jszip.min.js"></script>
  <script src="xlsx.full.min.js"></script>

  <script>
    // Variables globales
    let delitosElegidos = [];

    // Mostrar inputs "OTRO" y bloquear Nº Documento si indocumentado
    document.addEventListener('change', e => {
      if (e.target.id === "tipoDocumento") {
        const val = e.target.value;
        document.getElementById('tipoDocumentoOtro').style.display = (val === "OTRO") ? "block" : "none";
        const num = document.getElementById("numeroDocumento");
        if (val === "INDOCUMENTADO/A") { num.value = ""; num.disabled = true; } else { num.disabled = false; }
      }
      if (e.target.id === "interpreteOpcion") {
        document.getElementById('idioma').style.display = (e.target.value === "OTRO") ? "block" : "none";
      }
      if (e.target.tagName === "SELECT" && e.target.closest('.field-card')) {
        const input = e.target.closest('.field-card').querySelector('input[type="text"]');
        if (input && !["tipoDocumento", "interpreteOpcion"].includes(e.target.id)) {
          input.style.display = (e.target.value === "OTRO") ? "block" : "none";
        }
      }
    });

    // Manejo de delitos
    const selectDelito = document.getElementById("delitoSelect");
    const lista = document.getElementById("delitosSeleccionados");
    const inputOtro = document.getElementById("delitoOtroTexto");

    selectDelito.addEventListener("change", () => {
      const val = selectDelito.value;
      if (val === "OTRO") {
        inputOtro.style.display = "inline-block";
        inputOtro.focus();
        return;
      }
      if (val && !delitosElegidos.includes(val)) {
        delitosElegidos.push(val);
        renderDelitos();
      }
      selectDelito.value = "";
    });

    inputOtro.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const val = inputOtro.value.trim();
        if (val && !delitosElegidos.includes(val)) {
          delitosElegidos.push(val);
          renderDelitos();
        }
        inputOtro.value = "";
        inputOtro.style.display = "none";
        selectDelito.value = "";
      }
    });

    function renderDelitos() {
      lista.innerHTML = "";
      if (delitosElegidos.length === 0) {
        lista.innerHTML = "<em>Ningún delito seleccionado</em>";
        return;
      }
      delitosElegidos.forEach((d, i) => {
        const span = document.createElement("span");
        span.textContent = d;
        span.style.cssText = "padding:3px 6px; margin:2px; background:#eef; border:1px solid #99c; border-radius:4px; display:inline-block; cursor:pointer; color:#000;";
        span.title = "Click para eliminar";
        span.addEventListener("click", () => {
          delitosElegidos.splice(i, 1);
          renderDelitos();
        });
        lista.appendChild(span);
      });
    }

    // Normalizar clave para comparación
    function normalizeKey(str) {
      return str
        ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-Z0-9]/g, "").trim()
        : "";
    }

    // Manejar selects con input asociado (NO APORTA / OTRO)
    function setSelectWithInput(selectName, excelValue) {
      const select = document.querySelector(`[name="${selectName}"]`);
      if (!select) return;

      const card = select.closest(".field-card");
      const textInput = card ? card.querySelector("input[type=text], textarea") : null;
      const normExcel = normalizeKey(excelValue);

      let matched = false;
      for (const opt of select.options) {
        if (normalizeKey(opt.value) === normExcel) {
          select.value = opt.value;
          matched = true;
          if (textInput) textInput.value = "";
          break;
        }
      }

      if (!matched) {
        if (!excelValue || ["NOAPORTA", "NO", "DEOFICIO"].includes(normExcel)) {
          const fallback = Array.from(select.options).find(opt =>
            ["NOAPORTA", "NO", "DEOFICIO"].includes(normalizeKey(opt.value))
          );
          if (fallback) select.value = fallback.value;
          if (textInput) textInput.value = "";
        } else {
          const otherOpt = Array.from(select.options).find(opt => normalizeKey(opt.value) === "OTRO");
          if (otherOpt) select.value = otherOpt.value;
          if (textInput) textInput.value = excelValue;
        }
      }

      select.dispatchEvent(new Event("change"));
    }

    // Cargar Excel y rellenar formulario
    async function cargarExcel() {
      const input = document.getElementById("fileInputXLSX");
      input.click();

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          rows.forEach(([pregunta, respuesta]) => {
            if (!pregunta) return;
            const qNorm = normalizeKey(pregunta);
            const r = (respuesta || "").toString().trim();

            // Campos con opción OTRO
            if (qNorm === "DOMICILIO") { setSelectWithInput("DOMICILIO_OPCION", r); return; }
            if (qNorm === "TELEFONO") { setSelectWithInput("TELÉFONO_OPCION", r); return; }
            if (qNorm === "NOMBREDELOSPADRES") { setSelectWithInput("NOMBRE_PADRES_OPCION", r); return; }
            if (qNorm === "ABOGADO") { setSelectWithInput("ABOGADO_OPCION", r); return; }
            if (qNorm === "COMUNICARSECON") { setSelectWithInput("COMUNICARSE CON_OPCION", r); return; }
            if (qNorm === "INFORMARDESUDETENCION" || qNorm === "INFORMARDESUDETENCIONA") {
              setSelectWithInput("INFORMAR DE SU DETENCIÓN_OPCION", r); return;
            }
            if (qNorm === "INTERPRETE") { setSelectWithInput("INTERPRETE_OPCION", r); return; }

            // Delitos múltiples
            if (qNorm === "DELITO") {
              delitosElegidos = r.split(/,\s*|\s+y\s+/).map(v => v.trim()).filter(Boolean);
              renderDelitos();
              return;
            }

            // Campos simples
            const allInputs = document.querySelectorAll("[name]");
            for (const el of allInputs) {
              const elNorm = normalizeKey(el.name);
              if (elNorm === qNorm) {
                if (el.tagName === "SELECT") {
                  el.value = r;
                  el.dispatchEvent(new Event("change"));
                } else if (el.tagName === "INPUT" && el.type === "time") {
                  if (/^\d{1,2}:\d{2}$/.test(r)) {
                    el.value = r.padStart(5, '0');
                  } else {
                    el.value = "";
                  }
                } else {
                  el.value = r;
                }
                break;
              }
            }
          });

          document.getElementById("message").innerText = "✅ XLSX cargado y formulario rellenado";
        } catch (err) {
          console.error(err);
          document.getElementById("message").innerText = "❌ Error al cargar XLSX: " + (err?.message || err);
        }
      };
    }

    // Generar XLSX sin cabecera, dos columnas, ancho máx 40 chars, A derecha, B centrada, horas con formato h:mm
    async function generarXLSXUint8(rows, sheetName = "Resumen") {
      const x = new JSZip();

      const contentTypes =
        `<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;

      const rels =
        `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;

      const wb =
        `<?xml version="1.0" encoding="UTF-8"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <bookViews><workbookView/></bookViews>
  <sheets>
    <sheet name="${sheetName}" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>`;

      const wbRels =
        `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

      const styles =
        `<?xml version="1.0" encoding="UTF-8"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <numFmts count="1">
    <numFmt numFmtId="165" formatCode="h:mm"/>
  </numFmts>
  <fonts count="1">
    <font><sz val="11"/><color theme="1"/><name val="Calibri"/></font>
  </fonts>
  <fills count="1"><fill><patternFill patternType="none"/></fill></fills>
  <borders count="1"><border><left/><right/><top/><bottom/><diagonal/></border></borders>
  <cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
  <cellXfs count="4">
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="top"/></xf>
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="top" horizontal="right"/></xf>
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0" applyAlignment="1"><alignment wrapText="1" vertical="center" horizontal="center"/></xf>
    <xf numFmtId="165" fontId="0" fillId="0" borderId="0" applyNumberFormat="1" applyAlignment="1"><alignment vertical="center" horizontal="center"/></xf>
  </cellXfs>
  <cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles>
</styleSheet>`;

      const cols = `<cols>
        <col min="1" max="1" width="40" customWidth="1"/>
        <col min="2" max="2" width="40" customWidth="1"/>
      </cols>`;

      function cellInline(r, cIdx, text, style) {
        const col = (cIdx === 1 ? 'A' : 'B');
        const ref = col + r;
        const s = (style != null) ? ` s="${style}"` : '';
        return `<c r="${ref}" t="inlineStr"${s}><is><t>${text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</t></is></c>`;
      }
      function cellNumber(r, cIdx, num, style) {
        const col = (cIdx === 1 ? 'A' : 'B');
        const ref = col + r;
        const s = (style != null) ? ` s="${style}"` : '';
        return `<c r="${ref}"${s}><v>${num}</v></c>`;
      }

      function parseTimeToExcelFraction(str) {
        const m = /^(\d{1,2}):(\d{2})$/.exec(str || "");
        if (!m) return null;
        const h = Math.min(23, parseInt(m[1], 10));
        const mm = Math.min(59, parseInt(m[2], 10));
        return (h / 24) + (mm / 1440);
      }

      let rowXml = '';
      for (let i = 0; i < rows.length; i++) {
        const r = i + 1;
        const pregunta = rows[i][0] ?? '';
        const respuesta = rows[i][1] ?? '';

        const a = cellInline(r, 1, pregunta, 1);

        let b;
        if (pregunta === "Hora del hecho" || pregunta === "Hora de la detención") {
          const frac = parseTimeToExcelFraction(respuesta);
          if (frac != null) { b = cellNumber(r, 2, frac, 3); } else { b = cellInline(r, 2, respuesta, 2); }
        } else {
          b = cellInline(r, 2, respuesta, 2);
        }

        rowXml += `<row r="${r}" spans="1:2">${a}${b}</row>`;
      }

      const sheet =
        `<?xml version="1.0" encoding="UTF-8"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  ${cols}
  <sheetData>
    ${rowXml}
  </sheetData>
  <sheetViews>
    <sheetView tabSelected="1" workbookViewId="0"/>
  </sheetViews>
</worksheet>`;

      const core =
        `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"
 xmlns:dc="http://purl.org/dc/elements/1.1/"
 xmlns:dcterms="http://purl.org/dc/terms/"
 xmlns:dcmitype="http://purl.org/dcmitype/"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:title>Resumen Registro</dc:title>
  <dc:subject>Registro de Detenidos</dc:subject>
  <dc:creator>Formulario Registro</dc:creator>
  <cp:lastModifiedBy>Formulario Registro</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
  <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
</cp:coreProperties>`;

      const app =
        `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"
 xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>Formulario Registro</Application>
  <DocSecurity>0</DocSecurity>
  <ScaleCrop>false</ScaleCrop>
  <Company></Company>
  <LinksUpToDate>false</LinksUpToDate>
  <SharedDoc>false</SharedDoc>
  <HyperlinksChanged>false</HyperlinksChanged>
  <AppVersion>16.0000</AppVersion>
</Properties>`;

      x.file('[Content_Types].xml', contentTypes);
      x.folder('_rels').file('.rels', rels);
      const xl = x.folder('xl');
      xl.file('workbook.xml', wb);
      xl.folder('_rels').file('workbook.xml.rels', wbRels);
      xl.file('styles.xml', styles);
      xl.folder('worksheets').file('sheet1.xml', sheet);
      const props = x.folder('docProps');
      props.file('core.xml', core);
      props.file('app.xml', app);

      return await x.generateAsync({ type: 'uint8array' });
    }

    // Generar y descargar XLSX resumen
    async function generarXLSXResumen() {
      const msg = document.getElementById("message");
      msg.innerText = "Generando XLSX...";

      try {
        const form = document.getElementById("registroForm");
        const fd = new FormData(form);
        const data = {};
        fd.forEach((v, k) => data[k] = v);

        // Normalizaciones previas para OTRO
        const optTD = data["TIPO DOCUMENTO_OPCION"];
        data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"] || "") : optTD;
        if (optTD === "INDOCUMENTADO/A") { data["NºDOCUMENTO"] = ""; } else { data["NºDOCUMENTO"] = data["NºDOCUMENTO"] || ""; }
        data["SEXO"] = data["SEXO_OPCION"] || "";
        data["INSTRUCTOR"] = data["INSTRUCTOR"] || "";

        // Normalizar delitos
        let delitoTexto = "";
        if (delitosElegidos.length === 1) {
          delitoTexto = delitosElegidos[0];
        } else if (delitosElegidos.length === 2) {
          delitoTexto = delitosElegidos[0] + " y " + delitosElegidos[1];
        } else if (delitosElegidos.length > 2) {
          delitoTexto = delitosElegidos.slice(0, -1).join(", ") + " y " + delitosElegidos[delitosElegidos.length - 1];
        }
        data["DELITO"] = delitoTexto;

        // OTRO para selects con input
        const nomDisplay = (data["NOMBRE_PADRES_OPCION"] === "OTRO") ? (data["NOMBRE_PADRES"] || "") : (data["NOMBRE_PADRES_OPCION"] || "");
        const domDisplay = (data["DOMICILIO_OPCION"] === "OTRO") ? (data["DOMICILIO"] || "") : (data["DOMICILIO_OPCION"] || "");
        const telDisplay = (data["TELÉFONO_OPCION"] === "OTRO") ? (data["TELÉFONO"] || "") : (data["TELÉFONO_OPCION"] || "");

        data["MEDICO"] = (data["MEDICO"] === "SI") ? "SI" : "NO";
        data["CONSULADO"] = (data["CONSULADO"] === "SI") ? "SI" : "NO";

        data["NOMBRE_PADRES"] = nomDisplay;
        data["Nombre de los Padres"] = nomDisplay;
        data["DOMICILIO"] = domDisplay;
        data["TELÉFONO"] = telDisplay;

        // Intérprete
        const intOpt = data["INTERPRETE_OPCION"] || "NO";
        let interpreteDisplay = "NO";
        if (intOpt === "OTRO") {
          interpreteDisplay = data["IDIOMA"] || "";
        } else if (intOpt !== "NO") {
          interpreteDisplay = intOpt;
        }
        data["IDIOMA"] = interpreteDisplay;
        data["INTERPRETE"] = interpreteDisplay;

        // Construir filas para XLSX
        const filas = [
          ["Nombre", data["Nombre"]?.toUpperCase() || ""],
          ["Apellidos", data["APELLIDOS"]?.toUpperCase() || ""],
          ["Tipo de documento", data["TIPO DOCUMENTO"]?.toUpperCase() || ""],
          ["Nº Documento", data["NºDOCUMENTO"]?.toUpperCase() || ""],
          ["Sexo", data["SEXO"]?.toUpperCase() || ""],
          ["Nacionalidad", data["NACIONALIDAD"]?.toUpperCase() || ""],
          ["Nombre de los Padres", data["Nombre de los Padres"]?.toUpperCase() || ""],
          ["Fecha de nacimiento", data["FECHA DE NACIMIENTO"]?.toUpperCase() || ""],
          ["Lugar de nacimiento", data["LUGAR DE NACIMIENTO"]?.toUpperCase() || ""],
          ["Domicilio", domDisplay.toUpperCase() || ""],
          ["Teléfono", telDisplay.toUpperCase() || ""],
          ["Delito", delitoTexto.toUpperCase() || ""],
          ["C.P. Agentes", data["C.P. AGENTES"]?.toUpperCase() || ""],
          ["Diligencias", data["DILIGENCIAS"]?.toUpperCase() || ""],
          ["Instructor", data["INSTRUCTOR"]?.toUpperCase() || ""],
          ["Lugar del hecho", data["LUGAR DEL HECHO"]?.toUpperCase() || ""],
          ["Lugar de la detención", data["LUGAR DE LA DETENCIÓN"]?.toUpperCase() || ""],
          ["Hora del hecho", (document.getElementById('horaHecho')?.value || data["HORA DEL HECHO"] || "").trim()],
          ["Hora de la detención", (document.getElementById('horaDetencion')?.value || data["HORA DE LA DETENCIÓN"] || "").trim()],
          ["Breve resumen de los hechos", data["BREVE RESUMEN DE LOS HECHOS"]?.toUpperCase() || ""],
          ["Indicios por los que se detiene", data["INDICIOS POR LOS QUE SE DETIENE"]?.toUpperCase() || ""],
          ["Abogado", data["ABOGADO"]?.toUpperCase() || ""],
          ["Comunicarse con", data["COMUNICARSE CON:"]?.toUpperCase() || ""],
          ["Informar de su detención a:", data["INFORMAR DE SU DETENCION A:"]?.toUpperCase() || ""],
          ["Intérprete", interpreteDisplay.toUpperCase() || ""],
          ["Médico", data["MEDICO"]?.toUpperCase() || ""],
          ["Consulado", data["CONSULADO"]?.toUpperCase() || ""],
          ["Indicativo", data["Indicativo"]?.toUpperCase() || ""],
          ["Fecha de generación", data["FECHA_GENERACION"]?.toUpperCase() || ""]
        ];

        const xlsx = await generarXLSXUint8(filas, "Resumen");

        // Descargar XLSX
        const blob = new Blob([xlsx], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Resumen_${data["Nombre"] || "registro"}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        msg.innerText = "✅ XLSX generado y descargado";
      } catch (err) {
        console.error(err);
        document.getElementById("message").innerText = "❌ Error al generar XLSX: " + (err?.message || err);
      }
    }

    // Inicializar fecha actual en campo fechaGeneracion
    document.addEventListener("DOMContentLoaded", function () {
      const hoy = new Date();
      const dia = String(hoy.getDate()).padStart(2, '0');
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      const anio = hoy.getFullYear();
      const fecha = `${dia}/${mes}/${anio}`;

      const inputFecha = document.getElementById("fechaGeneracion");
      if (inputFecha && !inputFecha.value) {
        inputFecha.value = fecha;
      }
    });
  </script>
</body>
</html>
